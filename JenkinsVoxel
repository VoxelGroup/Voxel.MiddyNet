#!/usr/bin/env groovy

@Library('VoxelGroup/JenkinsSharedLibrary')_

pipeline {
	agent { label 'Windows-Procliance' }

	options {
        ansiColor('vga')	       
		buildDiscarder(logRotator(numToKeepStr: '10'))
		timeout(time: 30, unit: 'MINUTES') 
     }	    
	
	stages {	
		stage ('Start') {		
			steps {
				SetVersion(versionMajorAndMinor: '1.3')
			}
		}
		stage ('Build') {
			steps {					
				BuildNetCore(
					solution: 'Voxel.Middynet.sln', 
					version: env.VERSION
				)
			}
		}
		
		stage ('Test') {		
			steps {
				TestNetCore(solution: "Voxel.Middynet.sln")
			}
		}
		
		stage ('Publish'){
			when { branch 'main' }
			steps{
				GitHubCreateRelease (AllowBranch: "main", Version: env.VERSION)
				{	
					GitHubUploadAssetFile(
						UriToPublish: "Voxel.MiddyNet.${env.VERSION}.nupkg",
						FileName: "Voxel.MiddyNet"
					){};
					
					GitHubUploadAssetFile(
						UriToPublish: "Voxel.MiddyNet.SSMMiddleware.${env.VERSION}.nupkg",
						FileName: "Voxel.MiddyNet.SSMMiddleware"
					){};
					
					NugetPublish();
				}
			}
		}

	}
	
	post {
		always {
			ConsoleParsing();
		}
	}
}